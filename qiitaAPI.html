<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <title>Qiita API を使って記事を取得</title>
    <!-- <meta name="description" content="ディスクリプションを入力"> -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- <link rel="stylesheet" href="style.css"> -->
    <!-- <script src="main.js"></script> -->
    <script type="text/javascript">
      window.onload = function () {
        const TOKEN = "28688fed6e6402e99b24f44b94c1efd7fb442ea8";
        const url = "https://qiita.com/api/v2/authenticated_user/items";

        let data = [];

        // 投稿の取得
        const fetchMyQiitaPosts = (async () => {
          const options = {
            method: "GET",
            headers: {
              Authorization: `Bearer ${TOKEN}`,
            },
          };
          try {
            const response = await fetch(url, options);
            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }
            data = await response.json();
            displayPosts(data);
          } catch (error) {
            console.error("Error fetching data:", error);
          }
        })();

        const stringDate = (date) => new Date(date).toLocaleDateString();

        const createItem = (title, dates, likes_count) => {
          const listItem = document.createElement("li");
          const textNode = document.createTextNode(
            `${title} (投稿日: ${dates.createdAtDate}, 更新日: ${dates.updatedAtDate} - いいね数： ${likes_count})`
          );
          listItem.appendChild(textNode);
          return listItem;
        };

        const displayPosts = (data) => {
          const postsList = document.getElementById("qiita-posts");
          const posts = data;
          postsList.innerHTML = "";

          const filteredPosts = posts.filter((post) => !post.private);
          filteredPosts.forEach((post) => {
            const dates = {
              createdAtDate: stringDate(post.created_at),
              updatedAtDate: stringDate(post.updated_at),
            };
            postsList.appendChild(
              createItem(post.title, dates, post.likes_count)
            );
          });
        };

        document
          .getElementById("sortBtn--newPostDate")
          .addEventListener("click", () => {
            const sortData = data.sort(
              (a, b) => new Date(b.created_at) - new Date(a.created_at)
            );
            displayPosts(sortData);
          });

        document
          .getElementById("sortBtn--descendingLikes")
          .addEventListener("click", () => {
            const sortData = data.sort((a, b) => b.likes_count - a.likes_count);
            displayPosts(sortData);
          });
      };
    </script>
  </head>

  <body>
    Qiita の記事一覧を表示
    <ul id="qiita-posts"></ul>
    <ul id="sortBtn">
      <li id="sortBtn--newPostDate">投稿日が新しい順</li>
      <li id="sortBtn--descendingLikes">いいね数が多い順</li>
    </ul>
  </body>
</html>
