<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="utf-8">
  <title>Qiita API を使って記事を取得</title>
  <!-- <meta name="description" content="ディスクリプションを入力"> -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- <link rel="stylesheet" href="style.css"> -->
  <!-- <script src="main.js"></script> -->
  <script type="text/javascript">
    window.onload = function () {
      const TOKEN = "28688fed6e6402e99b24f44b94c1efd7fb442ea8";
      const url = "https://qiita.com/api/v2/authenticated_user/items";
      let data = [];

      // 投稿の取得
      const fetchMyQiitaPosts = (async () => {
        const options = {
          method: "GET",
          headers: {
            Authorization: `Bearer ${TOKEN}`,
          },
        };

        try {
          const response = await fetch(url, options);
          if (!response.ok) {
            throw new Error("response is false. response.status: ", response.status);
          } else {
            data = await response.json();
            displayPosts(data);
          }
        } catch (error) {
          console.log("error: ", error);
        };
      })();

      const stringDate = (date) => new Date(date).toLocaleDateString();

      const createItem = (postDates) => {
        const listItem = document.createElement("li");
        const textNode = document.createTextNode(
          `${postDates.title} (投稿日: ${postDates.createdAtDate}, 更新日: ${postDates.updatedAtDate} - いいね数： ${postDates.likes_count})`
        );
        listItem.appendChild(textNode);
        return listItem;
      };

      const displayPosts = (posts) => {
        const postsList = document.getElementById("qiita-posts");
        postsList.innerHTML = "";

        const filteredPosts = posts.filter(post => !post.private);

        filteredPosts.forEach(post => {
          const postDates = {
            title: post.title,
            createdAtDate: stringDate(post.created_at),
            updatedAtDate: stringDate(post.updated_at),
            likesCount: post.likes_count,
          }
          const newItem = createItem(post, postDates);
          postsList.appendChild(newItem);
        });
      }

      // 投稿日が新しい順でソート
      document.getElementById("sortBtn--newPostDate").addEventListener("click", () => {
        const sortData = data.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
        displayPosts(sortData);
      });

      // いいね数が多い順でソート
      document.getElementById("sortBtn--descendingLikes").addEventListener("click", () => {
        const sortData = data.sort((a, b) => b.likes_count - a.likes_count);
        displayPosts(sortData);
      });
    }
  </script>
</head>

<body>

  Qiita の記事一覧を表示
  <ul id="qiita-posts"></ul>
  <ul id="sortBtn">
    <li id="sortBtn--newPostDate">投稿日が新しい順</li>
    <li id="sortBtn--descendingLikes">いいね数が多い順</li>
  </ul>
</body>

</html>